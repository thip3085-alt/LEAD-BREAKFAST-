<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0,user-scalable=no">
<title>Stranger Survivor: Eventos</title>
<style>
    body{margin:0;overflow:hidden;background:#050508;color:#fff;font-family:monospace}
    canvas{display:block}
    #menu, #level-up-screen, #game-over{position:fixed;inset:0;background:rgba(0,0,0,.9);display:flex;flex-direction:column;align-items:center;justify-content:center;z-index:10}
    #level-up-screen, #game-over{display:none}
    .card-container{display:flex;gap:15px;margin-top:20px;justify-content:center}
    .card{width:140px;height:200px;background:#1a1a2e;border:2px solid #e94560;border-radius:12px;display:flex;flex-direction:column;align-items:center;justify-content:center;cursor:pointer;padding:10px;text-align:center}
    button{padding:15px 40px;font-size:20px;background:#900;color:#fff;border:2px solid #f00;border-radius:8px;cursor:pointer}
    #ui{position:fixed;top:10px;left:50%;transform:translateX(-50%);width:250px;text-align:center;background:rgba(0,0,0,0.6);padding:10px;border-radius:10px}
    .bar-bg{width:100%;height:10px;background:#333;border-radius:5px;margin-top:4px;overflow:hidden}
    #xp-bar{width:0%;height:100%;background:#00f2fe}
    #hp-bar{width:100%;height:100%;background:#f00}
    #kills{position:fixed;top:10px;right:10px;color:red;font-size:22px}
    #timer{position:fixed;top:40px;right:10px;color:white;font-size:16px}
    #joy-zone{position:fixed;bottom:30px;left:30px;width:120px;height:120px;border-radius:50%;background:rgba(255,255,255,.1)}
    #stick{width:50px;height:50px;border-radius:50%;background:red;position:absolute;left:35px;top:35px}
</style>
</head>
<body>

<div id="menu">
    <h1>STRANGER SURVIVOR</h1>
    <p>A cada 50s, um perigo pode surgir...</p>
    <button onclick="startGame()">INICIAR JOGO</button>
</div>

<div id="game-over">
    <h1 style="color:red; font-size:40px">VOCÃŠ MORREU</h1>
    <button onclick="location.reload()">RECOMENÃ‡AR</button>
</div>

<div id="level-up-screen">
    <h2>ESCOLHA UM POWER-UP</h2>
    <div class="card-container" id="cards"></div>
</div>

<div id="ui">
    <div style="display:flex;justify-content:space-between;font-size:12px">
        <span>LVL: <span id="lvl-val">1</span></span>
        <span>VIDA</span>
    </div>
    <div class="bar-bg"><div id="hp-bar"></div></div>
    <div class="bar-bg"><div id="xp-bar"></div></div>
</div>

<div id="kills">ðŸ’€ 0</div>
<div id="timer">Tempo: 0s</div>
<div id="joy-zone"><div id="stick"></div></div>

<canvas id="game"></canvas>

<script>
const canvas=document.getElementById("game"),ctx=canvas.getContext("2d");
function resize(){canvas.width=innerWidth;canvas.height=innerHeight}
resize();addEventListener("resize",resize);

const audioCtx=new (window.AudioContext||window.webkitAudioContext)();
function sound(f=400,d=0.06,v=0.05){
    let o=audioCtx.createOscillator(),g=audioCtx.createGain();
    o.frequency.value=f;g.gain.value=v;
    o.connect(g);g.connect(audioCtx.destination);
    o.start();o.stop(audioCtx.currentTime+d);
}

let player, enemies, bullets, xpOrbs, kills, shake, paused, gameActive, gameTime, lastEventTime;

function initVariables() {
    player={x:0,y:0,hp:100,maxHp:100,lvl:1,xp:0,nextLvl:10,speed:4,damage:25,fireRate:300,multishot:1};
    enemies=[]; bullets=[]; xpOrbs=[];
    kills=0; shake=0; paused=false; gameActive=true;
    gameTime=0; lastEventTime=0;
}

const allPowers=[
    {n:"DANO", d:"+25", f:()=>{player.damage+=25}},
    {n:"MULTI-TIRO", d:"+1 Bala", f:()=>{player.multishot++}},
    {n:"VELOCIDADE", d:"+1", f:()=>{player.speed+=1}},
    {n:"REGEN", d:"Vida Full", f:()=>{player.hp=player.maxHp}}
];

function showLevelUp(){
    paused=true;
    const container=document.getElementById("cards");
    container.innerHTML="";
    [...allPowers].sort(()=>0.5-Math.random()).slice(0,3).forEach(p=>{
        const div=document.createElement("div");
        div.className="card";
        div.innerHTML=`<h3>${p.n}</h3><p>${p.d}</p>`;
        div.onclick=()=>{ p.f(); paused=false; document.getElementById("level-up-screen").style.display="none"; };
        container.appendChild(div);
    });
    document.getElementById("level-up-screen").style.display="flex";
}

function gameOver(){
    gameActive=false;
    document.getElementById("game-over").style.display="flex";
}

/* CONTROLES */
let keys={},joy={x:0,y:0,tx:0,ty:0};
addEventListener("keydown",e=>keys[e.key.toLowerCase()]=true);
addEventListener("keyup",e=>keys[e.key.toLowerCase()]=false);
const joyZone=document.getElementById("joy-zone"),stick=document.getElementById("stick");
joyZone.ontouchmove=e=>{
    let r=joyZone.getBoundingClientRect(),t=e.touches[0];
    let dx=t.clientX-(r.left+r.width/2),dy=t.clientY-(r.top+r.height/2);
    let d=Math.hypot(dx,dy),m=r.width/2;
    if(d>10){let a=Math.atan2(dy,dx);joy.tx=Math.cos(a)*Math.min(d/m,1);joy.ty=Math.sin(a)*Math.min(d/m,1)}
};
joyZone.ontouchend=()=>joy.tx=joy.ty=0;

function drawEnemy(e){
    ctx.save(); ctx.translate(e.x,e.y);
    // Barra de Vida
    ctx.fillStyle="red"; ctx.fillRect(-15, -e.size-15, 30, 4);
    ctx.fillStyle="#0f0"; ctx.fillRect(-15, -e.size-15, 30*(e.hp/e.maxHp), 4);

    if(e.type==="vecna"){
        ctx.fillStyle="#400"; ctx.fillRect(-15, -50, 30, 50); // Vecna humanoide escuro
        ctx.fillStyle="red"; ctx.beginPath(); ctx.arc(0,-45,8,0,Math.PI*2); ctx.fill();
    } else if(e.type==="mindflayer"){
        ctx.fillStyle="#111"; ctx.beginPath(); ctx.arc(0,-30,25,0,Math.PI*2); ctx.fill(); // Sombra do Devorador
        ctx.strokeStyle="#111"; ctx.lineWidth=4;
        for(let i=0;i<6;i++){ // TentÃ¡culos
            ctx.beginPath(); ctx.moveTo(0,-30); ctx.lineTo(Math.cos(i)*40, Math.sin(i)*40); ctx.stroke();
        }
    } else if(e.type==="gorgon"){
        ctx.fillStyle="#a39a94"; ctx.fillRect(-12, -35, 24, 35); // Demogorgon (10px maior)
        ctx.fillStyle="#500"; ctx.beginPath(); ctx.arc(0,-35,10,0,Math.PI*2); ctx.fill();
    } else {
        ctx.fillStyle="#a39a94"; ctx.fillRect(-12, -12, 24, 12); // Demodog
        ctx.fillStyle="#500"; ctx.beginPath(); ctx.arc(12,-10,7,0,Math.PI*2); ctx.fill();
    }
    ctx.restore();
}

function checkEvent(){
    let seconds = Math.floor(gameTime / 60);
    if(seconds > 0 && seconds % 50 === 0 && seconds !== lastEventTime){
        lastEventTime = seconds;
        let sorte = Math.random();
        if(sorte < 0.2){ // 20% Vecna
            spawnBoss("vecna", 2000, 1.5);
        } else if(sorte < 0.4){ // 20% Mindflayer
            spawnBoss("mindflayer", 3500, 1.2);
        } else {
            // 60% chance de nÃ£o aparecer nada
            console.log("Nada aconteceu desta vez...");
        }
    }
}

function spawnBoss(type, hp, spd){
    let a=Math.random()*Math.PI*2, dist=800;
    enemies.push({
        x:player.x+Math.cos(a)*dist, y:player.y+Math.sin(a)*dist,
        hp:hp, maxHp:hp, spd:spd, type:type, size:60
    });
    sound(50, 0.5, 0.3); // Som grave de perigo
}

let lastShot=0;
function loop(){
    if(!gameActive) return;
    if(paused){ requestAnimationFrame(loop); return; }
    
    gameTime++;
    checkEvent();
    document.getElementById("timer").innerText = `Tempo: ${Math.floor(gameTime/60)}s`;

    ctx.save();
    if(shake>0){ctx.translate((Math.random()-.5)*shake,(Math.random()-.5)*shake);shake*=.9}
    ctx.fillStyle="#050508"; ctx.fillRect(0,0,canvas.width,canvas.height);

    joy.x+=(joy.tx-joy.x)*.25; joy.y+=(joy.ty-joy.y)*.25;
    stick.style.transform=`translate(${joy.x*40}px,${joy.y*40}px)`;
    let vx=(keys.a?-1:(keys.d?1:0)), vy=(keys.w?-1:(keys.s?1:0));
    player.x+=(vx+joy.x)*player.speed; player.y+=(vy+joy.y)*player.speed;

    ctx.translate(canvas.width/2-player.x, canvas.height/2-player.y);
    ctx.fillStyle="#38f"; ctx.beginPath(); ctx.arc(player.x,player.y,12,0,Math.PI*2); ctx.fill();

    // XP Orbs
    for(let i=xpOrbs.length-1;i>=0;i--){
        let o=xpOrbs[i]; let d=Math.hypot(player.x-o.x, player.y-o.y);
        if(d<150){ o.x+=(player.x-o.x)*0.1; o.y+=(player.y-o.y)*0.1; }
        ctx.fillStyle="#00f2fe"; ctx.beginPath(); ctx.arc(o.x,o.y,4,0,Math.PI*2); ctx.fill();
        if(d<20){
            xpOrbs.splice(i,1); player.xp++;
            if(player.xp>=player.nextLvl){ player.lvl++; player.xp=0; player.nextLvl+=5; showLevelUp(); }
        }
    }

    if(Math.random()<.03) spawnNormal();
    for(let i=enemies.length-1;i>=0;i--){
        let e=enemies[i]; let a=Math.atan2(player.y-e.y,player.x-e.x);
        e.x+=Math.cos(a)*e.spd; e.y+=Math.sin(a)*e.spd;
        drawEnemy(e);
        if(Math.hypot(player.x-e.x,player.y-e.y)<30){ 
            player.hp-=0.5; shake=5; 
            if(player.hp<=0) { gameOver(); return; } 
        }
        if(e.hp<=0){ xpOrbs.push({x:e.x, y:e.y}); enemies.splice(i,1); kills++; }
    }

    let n=Date.now();
    if(n-lastShot>player.fireRate){
        let t=null, d=500;
        enemies.forEach(e=>{let dist=Math.hypot(e.x-player.x,e.y-player.y); if(dist<d){d=dist;t=e}});
        if(t){
            lastShot=n; let a=Math.atan2(t.y-player.y,t.x-player.x);
            for(let j=0;j<player.multishot;j++){
                let off=(j-(player.multishot-1)/2)*0.2;
                bullets.push({x:player.x,y:player.y,vx:Math.cos(a+off)*12,vy:Math.sin(a+off)*12,life:50});
            }
        }
    }

    for(let i=bullets.length-1;i>=0;i--){
        let b=bullets[i]; b.x+=b.vx; b.y+=b.vy; b.life--;
        ctx.fillStyle="yellow"; ctx.beginPath(); ctx.arc(b.x,b.y,4,0,Math.PI*2); ctx.fill();
        enemies.forEach(e=>{ if(Math.hypot(b.x-e.x,b.y-e.y)<30){ e.hp-=player.damage; b.life=0; } });
        if(b.life<=0) bullets.splice(i,1);
    }

    ctx.restore();
    document.getElementById("hp-bar").style.width=(player.hp/player.maxHp)*100+"%";
    document.getElementById("xp-bar").style.width=(player.xp/player.nextLvl)*100+"%";
    document.getElementById("lvl-val").innerText=player.lvl;
    document.getElementById("kills").innerText="ðŸ’€ "+kills;
    requestAnimationFrame(loop);
}

function spawnNormal(){
    let a=Math.random()*Math.PI*2, dist=700;
    let type=Math.random()<0.3?"gorgon":"dog";
    enemies.push({
        x:player.x+Math.cos(a)*dist, y:player.y+Math.sin(a)*dist,
        hp:type==="gorgon"?150:60, maxHp:type==="gorgon"?150:60,
        spd:type==="gorgon"?2.2:3, type, size:type==="gorgon"?35:25
    });
}

function startGame(){
    initVariables();
    document.getElementById("menu").style.display="none";
    document.getElementById("game-over").style.display="none";
    audioCtx.resume();
    loop();
}
</script>
</body>
</html>

